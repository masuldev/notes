# ImagePullPolicy에 대한 오해
Deployment 컨트롤러를 정의할 때 컨테이너 별로 imagePullPolicy 옵션을 지정할 수 있다.  
기본값은 IfNotPresent 이고 일반적으로 Always 또는 IfNotPresent가 사용되는데, 이는 k8s 해당 node에 이미지 존재 유무에 따라 이미지 다운로드 여부를 결정한다.  
Always는 이미지가 있든 없든 무조건 다운로드 하라는 의미이고, IfNotPresent는 이미지가 없을 때에만 다운로드 하라는 의미이다.

우선 상용서버 배포시에는 무조건 IfNotPresent를 사용해야 할 것이다.  
Always를 사용할 경우 이미지가 있더라도 무조건 새로 다운로드 하기 때문에 name, tag는 변경이 없지만 실제 다른 버전이 적용될 수 있다.  
이렇게 적용된 사항은 추적이 어렵고 롤백을 하려면 소스빌드 단계부터 다시 수행해야 한다.  
그렇기 때문에 사용서버 배포시에는 IfNotPresent를 기본으로 하고 tag를 달리해서 배포를 하는게 정석이다.

하지만 개발서버에서는 어떨까.
로컬환경에서도 테스트를 하지만 개발서버에만 올려서 테스트를 해야하는 부분이 있고 실제로 많은 개발자들이 로컬환경보다는 개발서버에 올려서 테스트를 한다.  
이렇게 개발서버에 올려서 테스트를 하다보면 하루에도 수많은 테스트 버전이 생기게 된다.  
오타부터 시작해서 생각치 못했던 버그같은 것을 수정해야 하기 때문이다.  
이때 IfNotPresent를 사용하게 되면 매번 이미지 tag를 변경해서 빌드를 해야하고 Deployment.yaml 파일도 매번 변경해야 한다.  
오타나 버그수정 같은 수 많은 버전에 대해 새로운 tag를 가지는 이미지가 생겨나게 된다.  
이러한 버전은 의미가 없기 때문에 일반적으로 개발서버에서는 Always 값을 주고 사용하곤 한다.

**하지만 가끔 오해를 하는 부분이 생긴다**

이미 존재하는 이미지를 새로 받을 경우 기존에 존재하던 이미지의 tag는 `<none>` 로 변경되고 새로운 이미지를 받아오게 된다.  
이는 `docker images` 명령어로 확인할 수 있다.  
그런데 Always값을 주었는데도 이미지가 갱신되지 않는 경우가 있다.  
**하지만 이는 이미지가 갱신만 되지 않았을 뿐 다운로드 시도 자체는 정상적으로 한 것이다.**

이런 현상이 발생하는 이유는 저장소의 이미지와 로컬에 있는 이미지가 동일하기 때문이다.  
저장소에 저장되는 이미지는 name, tag 외에 push 할 때 마다 유니크하게 부여되는 digest 값이 존재한다.  

이로인해 동일한 name, tag를 가지는 이미지라 할지라도 그 중에 여러버전이 존재할 수 있고 pull 할 경우 가장 마지막에 push 된  
이미지의 name + tag + digest 를 비교값으로 사용하게 된다.

결국 저장소에서 어떠한 이름과 태그를 가지는 이미지 중 가장 마지막에 push 된 이미지의 name + tag + digest 와 로컬 저장소에 있는 값을  
비교해서 다운로드 여부를 결정한다.

ImagePullPolicy: Always 설정에 의해 이미지 다운로드 시도는 할테지만 이때 name + tag + digest 가 같다면 실제 다운로드는 하지 않는 것이다.